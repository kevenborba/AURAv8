{% extends "base.html" %}

{% block content %}
<div x-data="broadcastManager()" class="space-y-8">

    <!-- Header -->
    <div class="flex justify-between items-end">
        <div>
            <h1 class="text-3xl font-bold text-white flex items-center gap-3">
                <span class="text-yellow-500">ðŸ“¢</span> Broadcast System
            </h1>
            <p class="text-gray-400">Envie anÃºncios globais para todos os servidores ou donos.</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Editor -->
        <div class="glass-card p-6 rounded-2xl space-y-6">
            <h2 class="text-xl font-bold text-white mb-4">Editor de AnÃºncio</h2>

            <div>
                <label class="block text-sm font-medium text-gray-400 mb-1">TÃ­tulo</label>
                <input type="text" x-model="form.title"
                    class="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white focus:border-yellow-500 outline-none"
                    placeholder="Ex: ManutenÃ§Ã£o Programada">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-400 mb-1">DescriÃ§Ã£o</label>
                <textarea x-model="form.description" rows="5"
                    class="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white focus:border-yellow-500 outline-none"
                    placeholder="Mensagem do anÃºncio..."></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Cor (Hex)</label>
                    <input type="color" x-model="form.color" class="w-full h-10 rounded cursor-pointer bg-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Imagem URL</label>
                    <input type="text" x-model="form.image_url"
                        class="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white focus:border-yellow-500 outline-none"
                        placeholder="https://...">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">Destino</label>
                <div class="flex gap-4">
                    <label
                        class="flex items-center gap-2 bg-white/5 p-3 rounded-lg cursor-pointer hover:bg-white/10 w-full">
                        <input type="radio" name="target" value="owners" x-model="form.target"
                            class="text-yellow-500 focus:ring-yellow-500">
                        <span class="text-white">Donos (DM)</span>
                    </label>
                    <label
                        class="flex items-center gap-2 bg-white/5 p-3 rounded-lg cursor-pointer hover:bg-white/10 w-full">
                        <input type="radio" name="target" value="channels" x-model="form.target"
                            class="text-yellow-500 focus:ring-yellow-500">
                        <span class="text-white">Canais de Sistema/Geral</span>
                    </label>
                </div>
            </div>

            <button @click="sendBroadcast()" :disabled="sending"
                class="w-full py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg transition shadow-lg shadow-yellow-500/20 flex items-center justify-center gap-2">
                <span x-show="!sending">ðŸš€ ENVIAR BROADCAST</span>
                <span x-show="sending">Enviando... (<span x-text="progress"></span>%)</span>
            </button>
        </div>

        <!-- Preview -->
        <div class="glass-card p-6 rounded-2xl bg-[#36393f] border border-[#2f3136]">
            <h2 class="text-xs font-bold text-gray-500 uppercase mb-4 tracking-wider">Preview (Dark Theme)</h2>

            <div class="flex gap-4">
                <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold">
                    A</div>
                <div class="flex-grow">
                    <div class="flex items-baseline gap-2">
                        <span class="text-white font-medium">AURA</span>
                        <span class="text-[10px] text-white/70 bg-indigo-500 px-1 rounded">BOT</span>
                        <span class="text-xs text-gray-400">Hoje Ã s 12:00</span>
                    </div>

                    <!-- Embed Preview -->
                    <div class="mt-2 border-l-4 rounded bg-[#2f3136]" :style="`border-left-color: ${form.color};`">
                        <div class="p-4 grid gap-2">
                            <h3 class="text-white font-bold" x-text="form.title || 'TÃ­tulo do AnÃºncio'"></h3>
                            <p class="text-gray-300 text-sm whitespace-pre-wrap"
                                x-text="form.description || 'Sua mensagem aparecerÃ¡ aqui...'"></p>

                            <img x-show="form.image_url" :src="form.image_url"
                                class="w-full rounded mt-2 object-cover max-h-64">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    function broadcastManager() {
        return {
            form: {
                title: '',
                description: '',
                color: '#fbbf24',
                image_url: '',
                target: 'owners'
            },
            sending: false,
            progress: 0,

            async sendBroadcast() {
                if (!this.form.title || !this.form.description) return alert("TÃ­tulo e DescriÃ§Ã£o sÃ£o obrigatÃ³rios!");
                if (!confirm(`CONFIRMAR ENVIO?\n\nDestino: ${this.form.target}\nIsso pode demorar um pouco.`)) return;

                this.sending = true;
                this.progress = 0;

                // Simula progresso enquanto aguarda resposta (real progress precisa de websocket, polling ou SSE)
                const mockInterval = setInterval(() => { if (this.progress < 90) this.progress += 5; }, 500);

                try {
                    const res = await fetch('/owner/api/broadcast', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.form)
                    });
                    const data = await res.json();

                    clearInterval(mockInterval);
                    this.progress = 100;

                    if (data.success) {
                        alert(`Sucesso!\nEnviado para: ${data.sent_count}\nFalhas: ${data.failed_count}`);
                        this.form.title = '';
                        this.form.description = '';
                    } else {
                        alert("Erro: " + data.error);
                    }
                } catch (e) {
                    alert("Erro fatal: " + e);
                } finally {
                    this.sending = false;
                }
            }
        }
    }
</script>
{% endblock %}