{% extends "base.html" %}

{% block content %}
<div class="space-y-6" x-data="dbManager()">

    <!-- Header Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="glass-card p-6 rounded-2xl border border-white/5">
            <h3 class="text-gray-400 text-sm font-medium mb-1">Tamanho do Banco</h3>
            <div class="text-3xl font-bold text-white flex items-end gap-2">
                <span x-text="stats.size_mb">0</span>
                <span class="text-lg text-gray-500 mb-1">MB</span>
            </div>
        </div>
        <div class="glass-card p-6 rounded-2xl border border-white/5">
            <h3 class="text-gray-400 text-sm font-medium mb-1">Total de Linhas</h3>
            <div class="text-3xl font-bold text-white" x-text="stats.total_rows">0</div>
        </div>
        <div class="glass-card p-6 rounded-2xl border border-white/5 flex flex-col justify-center gap-3">
            <a href="/owner/api/database/backup"
                class="w-full py-2 bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 border border-blue-500/30 rounded-lg text-center transition font-bold">
                üì• Baixar Backup (.db)
            </a>
            <button @click="triggerRestore"
                class="w-full py-2 bg-yellow-600/20 hover:bg-yellow-600/30 text-yellow-400 border border-yellow-500/30 rounded-lg text-center transition font-bold">
                üì§ Restaurar Backup
            </button>
            <input type="file" x-ref="restoreInput" class="hidden" @change="uploadRestore">
        </div>
    </div>

    <!-- Data Explorer -->
    <div class="glass-card rounded-2xl overflow-hidden border border-white/5">
        <div class="p-6 border-b border-white/5 flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-white">Explorador de Dados</h2>
                <p class="text-sm text-gray-400">Gerencie os dados armazenados por servidor.</p>
            </div>
            <div>
                <button @click="triggerCleanup"
                    class="bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/30 px-4 py-2 rounded-lg transition font-bold text-sm mr-2">
                    üßπ LIMPAR INATIVOS
                </button>
                <button @click="fetchGuilds" class="text-gray-400 hover:text-white transition">
                    üîÑ Atualizar
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-gray-400 text-sm border-b border-white/5 bg-white/5">
                        <th class="p-4 font-medium">Servidor</th>
                        <th class="p-4 font-medium">ID</th>
                        <th class="p-4 font-medium">Status</th>
                        <th class="p-4 font-medium">Dados Armazenados</th>
                        <th class="p-4 font-medium text-right">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    <template x-for="guild in guilds" :key="guild.id">
                        <tr class="hover:bg-white/5 transition group">
                            <td class="p-4 text-white font-medium" x-text="guild.name || 'Desconhecido'"></td>
                            <td class="p-4 text-gray-400 font-mono text-xs" x-text="guild.id"></td>
                            <td class="p-4">
                                <span class="px-2 py-1 rounded text-xs font-bold uppercase" :class="{
                                        'bg-green-500/20 text-green-400': guild.status === 'online',
                                        'bg-red-500/20 text-red-400': guild.status === 'ghost'
                                    }" x-text="guild.status"></span>
                            </td>
                            <td class="p-4 text-gray-300">
                                <span x-text="guild.items_count || '?'"></span> itens
                            </td>
                            <td class="p-4 text-right">
                                <button @click="confirmWipe(guild)"
                                    class="text-red-500 hover:text-red-400 hover:bg-red-500/10 px-3 py-1 rounded transition opacity-0 group-hover:opacity-100 font-bold text-xs ring-1 ring-red-500/30">
                                    ‚ò¢Ô∏è WIPE DATA
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div x-show="guilds.length === 0" class="p-12 text-center text-gray-500">
            Carregando dados...
        </div>
    </div>

    <!-- Danger Modal -->
    <div x-show="showWipeModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm"
        x-transition.opacity style="display: none;">
        <div
            class="bg-[#1a1625] border border-red-500/50 p-8 rounded-2xl w-full max-w-md space-y-6 relative shadow-2xl shadow-red-900/20">
            <div class="text-center space-y-2">
                <div class="text-4xl">‚ò¢Ô∏è</div>
                <h2 class="text-2xl font-bold text-red-500">ZONA DE PERIGO</h2>
                <p class="text-gray-300">
                    Voc√™ est√° prestes a apagar <b>TODOS</b> os dados do servidor:<br>
                    <span class="text-white font-mono bg-white/10 px-2 py-1 rounded mt-2 inline-block"
                        x-text="wipeTarget?.name"></span>
                </p>
                <p class="text-sm text-gray-500">
                    Isso inclui Tickets, Configura√ß√µes, Logs, Rankings e A√ß√µes.<br>
                    <span class="text-red-400 font-bold">Esta a√ß√£o √© irrevers√≠vel.</span>
                </p>
            </div>

            <div class="bg-red-500/10 p-4 rounded-lg border border-red-500/20">
                <label class="block text-xs font-bold text-red-400 mb-2 uppercase tracking-wider">
                    Para confirmar, digite o ID do servidor:
                </label>
                <div class="font-mono text-center text-gray-500 text-sm mb-2" x-text="wipeTarget?.id"></div>
                <input type="text" x-model="confirmInput" placeholder="Cole o ID aqui"
                    class="w-full bg-black/50 border border-red-500/30 rounded-lg p-3 text-white text-center focus:border-red-500 outline-none font-mono">
            </div>

            <div class="flex items-center gap-2">
                <input type="checkbox" id="keepLicense" x-model="keepLicense"
                    class="rounded bg-white/10 border-white/20 text-purple-600">
                <label for="keepLicense" class="text-sm text-gray-300">Manter a Licen√ßa (apagar s√≥ dados)</label>
            </div>

            <div class="flex gap-3">
                <button @click="showWipeModal = false"
                    class="flex-1 py-3 rounded-lg font-bold text-gray-400 hover:bg-white/5 transition">
                    Cancelar
                </button>
                <button @click="executeWipe" :disabled="confirmInput !== wipeTarget?.id"
                    class="flex-1 py-3 rounded-lg font-bold text-white transition bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    CONFIRMAR APAGAR
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    function dbManager() {
        return {
            stats: { size_mb: 0, total_rows: 0, details: {} },
            guilds: [],
            wipeTarget: null,
            showWipeModal: false,
            confirmInput: '',
            keepLicense: true,

            init() {
                this.fetchStats();
                this.fetchGuilds();
            },

            async fetchStats() {
                const res = await fetch('/owner/api/database/stats');
                this.stats = await res.json();
            },

            async fetchGuilds() {
                const res = await fetch('/owner/api/database/guilds');
                this.guilds = await res.json();
            },

            triggerRestore() {
                this.$refs.restoreInput.click();
            },

            async uploadRestore(e) {
                const file = e.target.files[0];
                if (!file) return;

                if (!confirm("‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° SOBRESCREVER o banco de dados atual e reiniciar os dados. Continuar?")) {
                    e.target.value = '';
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await fetch('/owner/api/database/restore', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.success) {
                        alert("‚úÖ Banco restaurado com sucesso! Reinicie o bot para aplicar.");
                        window.location.reload();
                    } else {
                        alert("Erro: " + data.error);
                    }
                } catch (err) {
                    alert("Erro no upload: " + err);
                }
            },

            confirmWipe(guild) {
                this.wipeTarget = guild;
                this.confirmInput = '';
                this.keepLicense = true;
                this.showWipeModal = true;
            },

            async executeWipe() {
                if (this.confirmInput !== this.wipeTarget.id) return;

                const res = await fetch('/owner/api/database/wipe_guild', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        guild_id: this.wipeTarget.id,
                        keep_license: this.keepLicense
                    })
                });

                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ WIPE CONCLU√çDO. ${data.deleted_rows} registros apagados.`);
                    this.showWipeModal = false;
                    this.fetchGuilds();
                    this.fetchStats();
                } else {
                    alert("Erro ao apagar: " + data.error);
                }
            },

            async triggerCleanup() {
                if (!confirm("‚ö†Ô∏è LIMPEZA EM MASSA\n\nIsso vai apagar dados (tickets, configs, logs) de TODOS os servidores onde o bot N√ÉO est√° mais presente.\n\nLicen√ßas ser√£o mantidas.\n\nDeseja continuar?")) return;

                const res = await fetch('/owner/api/database/cleanup_inactive', { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    alert(`‚úÖ Limpeza Conclu√≠da!\n\n${data.deleted_rows} registros de servidores fantasmas foram removidos.`);
                    this.fetchGuilds();
                    this.fetchStats();
                } else {
                    alert("Erro: " + data.error);
                }
            }
        }
    }
</script>
{% endblock %}